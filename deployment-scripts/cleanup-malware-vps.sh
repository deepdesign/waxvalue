#!/bin/bash

# VPS Malware Cleanup Script
# REMOVES malicious files and directories found by security scan
# USE WITH CAUTION - Review findings before running cleanup

echo "üßπ VPS Malware Cleanup Script"
echo "=================================="
echo "‚ö†Ô∏è  WARNING: This script will DELETE files and directories!"
echo "‚ö†Ô∏è  Make sure you've reviewed the security scan results first!"
echo ""
read -p "Are you sure you want to proceed? (type 'yes' to continue): " confirm

if [ "$confirm" != "yes" ]; then
    echo "‚ùå Cleanup cancelled."
    exit 0
fi

echo ""
echo "üîç Starting cleanup..."
echo ""

CLEANED=0

# 1. Kill suspicious processes
echo "1Ô∏è‚É£  Killing suspicious processes..."
SUSPICIOUS_PROCS=$(ps aux | grep -E '\.(r0qsv8h1|394ly8v9|systemhelper|miner|crypto|bitcoin)' | grep -v grep | awk '{print $2}')
if [ ! -z "$SUSPICIOUS_PROCS" ]; then
    for pid in $SUSPICIOUS_PROCS; do
        echo "   Killing process $pid..."
        kill -9 $pid 2>/dev/null
        CLEANED=$((CLEANED + 1))
    done
else
    echo "   ‚úì No suspicious processes found"
fi
echo ""

# 2. Remove suspicious directories
echo "2Ô∏è‚É£  Removing suspicious directories..."
SUSPICIOUS_DIRS=(
    "/root/.local/share/.r0qsv8h1"
    "/var/tmp/.systemhelper"
    "/root/.systemhelper"
    "/tmp/miner"
    "/tmp/crypto"
)
for dir in "${SUSPICIOUS_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        echo "   Removing: $dir"
        rm -rf "$dir"
        CLEANED=$((CLEANED + 1))
    fi
done
echo ""

# 3. Remove suspicious cron jobs
echo "3Ô∏è‚É£  Cleaning suspicious cron jobs..."
# Get all cron jobs
ALL_CRON=$(for user in $(cut -f1 -d: /etc/passwd); do crontab -l -u "$user" 2>/dev/null | grep -v '^#' | grep -v '^$' | sed "s/^/$user: /"; done)
SUSPICIOUS_CRON=$(echo "$ALL_CRON" | grep -E 'curl.*bash|wget.*bash|\.sh.*http|systemhelper|miner|crypto')

if [ ! -z "$SUSPICIOUS_CRON" ]; then
    echo "   ‚ö†Ô∏è  Suspicious cron jobs found. Manual removal required:"
    echo "$SUSPICIOUS_CRON"
    echo ""
    echo "   To remove, run: crontab -e (for current user)"
    echo "   Or: crontab -u <username> -e (for specific user)"
else
    echo "   ‚úì No suspicious cron jobs found"
fi
echo ""

# 4. Remove suspicious systemd services
echo "4Ô∏è‚É£  Checking systemd services..."
SUSPICIOUS_SERVICES=$(systemctl list-units --type=service --all | grep -E 'systemhelper|miner|crypto|suspicious' || true)
if [ ! -z "$SUSPICIOUS_SERVICES" ]; then
    echo "   ‚ö†Ô∏è  Suspicious services found. Manual removal required:"
    echo "$SUSPICIOUS_SERVICES"
    echo ""
    echo "   To remove, run:"
    echo "   sudo systemctl stop <service-name>"
    echo "   sudo systemctl disable <service-name>"
    echo "   sudo rm /etc/systemd/system/<service-name>.service"
else
    echo "   ‚úì No suspicious systemd services found"
fi
echo ""

# 5. Remove PHP shells (with confirmation per file)
echo "5Ô∏è‚É£  Scanning for PHP shells..."
PHP_SHELLS=$(find / -type f -name "*.php" \( -path /proc -o -path /sys -o -path /dev -o -path /run -o -path /boot -o -path /lost+found \) -prune -o -type f -name "*.php" -print 2>/dev/null | xargs grep -l "eval.*base64_decode\|system.*exec\|shell_exec.*passthru" 2>/dev/null | head -20)

if [ ! -z "$PHP_SHELLS" ]; then
    echo "   ‚ö†Ô∏è  PHP shells found. Review these files manually:"
    echo "$PHP_SHELLS"
    echo ""
    read -p "   Remove these PHP shell files? (type 'yes' to remove): " remove_php
    if [ "$remove_php" = "yes" ]; then
        for file in $PHP_SHELLS; do
            echo "   Removing: $file"
            rm -f "$file"
            CLEANED=$((CLEANED + 1))
        done
    fi
else
    echo "   ‚úì No obvious PHP shells found"
fi
echo ""

# 6. Remove suspicious scripts
echo "6Ô∏è‚É£  Scanning for suspicious scripts..."
SUSPICIOUS_SCRIPTS=$(find / -type f \( -name "*.sh" -o -name "*.py" -o -name "*.js" \) \( -path /proc -o -path /sys -o -path /dev -o -path /run -o -path /boot -o -path /lost+found \) -prune -o -type f \( -name "*.sh" -o -name "*.py" -o -name "*.js" \) -print 2>/dev/null | xargs grep -l "curl.*bash.*http\|wget.*bash.*http\|base64.*decode.*eval" 2>/dev/null | head -20)

if [ ! -z "$SUSPICIOUS_SCRIPTS" ]; then
    echo "   ‚ö†Ô∏è  Suspicious scripts found. Review these files manually:"
    echo "$SUSPICIOUS_SCRIPTS"
    echo ""
    read -p "   Remove these suspicious scripts? (type 'yes' to remove): " remove_scripts
    if [ "$remove_scripts" = "yes" ]; then
        for file in $SUSPICIOUS_SCRIPTS; do
            echo "   Removing: $file"
            rm -f "$file"
            CLEANED=$((CLEANED + 1))
        done
    fi
else
    echo "   ‚úì No obvious malicious scripts found"
fi
echo ""

# Summary
echo "=================================="
echo "üìä CLEANUP SUMMARY"
echo "=================================="
if [ $CLEANED -eq 0 ]; then
    echo "‚úÖ No malicious files found or removed."
else
    echo "‚úÖ Cleaned $CLEANED malicious item(s)"
fi
echo ""
echo "‚ö†Ô∏è  IMPORTANT: Review any flagged cron jobs and systemd services manually!"
echo "‚ö†Ô∏è  Some items require manual removal for safety."
echo ""
echo "üí° Next steps:"
echo "   1. Review cron jobs: crontab -l (for each user)"
echo "   2. Review systemd services: systemctl list-units --type=service"
echo "   3. Check for any remaining suspicious processes: ps aux | grep -E 'miner|crypto|systemhelper'"
echo "   4. Run the security scan again to verify cleanup"
echo ""


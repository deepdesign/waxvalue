#!/bin/bash
# Comprehensive malware cleanup script for VPS
# Run this on your VPS server as root

set -e

echo "=========================================="
echo "  MALWARE CLEANUP & SECURITY HARDENING"
echo "=========================================="
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Step 1: Kill malicious processes
echo -e "${YELLOW}[1/8] Killing malicious processes...${NC}"
pkill -f systemhelper 2>/dev/null || true
pkill -f ".r0qsv8h1" 2>/dev/null || true
pkill -f ".fvq2lzl64e" 2>/dev/null || true
pkill -f "minerd" 2>/dev/null || true
pkill -f "xmrig" 2>/dev/null || true
pkill -f "stratum" 2>/dev/null || true
sleep 2
echo -e "${GREEN}✓ Malicious processes killed${NC}"

# Step 2: Remove malicious files
echo -e "${YELLOW}[2/8] Removing malicious files...${NC}"
rm -f /usr/local/bin/systemhelper
rm -f /etc/init.d/systemhelper
rm -rf /root/.local/share/.r0qsv8h1
rm -rf /tmp/.r0qsv8h1
rm -rf /var/tmp/.r0qsv8h1
rm -f /tmp/dockerd
rm -f /tmp/*.js 2>/dev/null || true
echo -e "${GREEN}✓ Malicious files removed${NC}"

# Step 3: Clean persistence mechanisms
echo -e "${YELLOW}[3/8] Cleaning persistence mechanisms...${NC}"

# Clean .bashrc
if grep -q "systemhelper\|\.r0qsv8h1\|\.fvq2lzl64e" ~/.bashrc 2>/dev/null; then
    sed -i '/systemhelper\|\.r0qsv8h1\|\.fvq2lzl64e/d' ~/.bashrc
    echo -e "${GREEN}✓ Cleaned ~/.bashrc${NC}"
fi

# Clean .profile
if grep -q "systemhelper\|\.r0qsv8h1\|\.fvq2lzl64e" ~/.profile 2>/dev/null; then
    sed -i '/systemhelper\|\.r0qsv8h1\|\.fvq2lzl64e/d' ~/.profile
    echo -e "${GREEN}✓ Cleaned ~/.profile${NC}"
fi

# Clean .bash_profile
if [ -f ~/.bash_profile ]; then
    if grep -q "systemhelper\|\.r0qsv8h1\|\.fvq2lzl64e" ~/.bash_profile 2>/dev/null; then
        sed -i '/systemhelper\|\.r0qsv8h1\|\.fvq2lzl64e/d' ~/.bash_profile
        echo -e "${GREEN}✓ Cleaned ~/.bash_profile${NC}"
    fi
fi

# Clean crontab
crontab -l 2>/dev/null | grep -v "systemhelper\|\.r0qsv8h1\|\.fvq2lzl64e" | crontab - 2>/dev/null || true
echo -e "${GREEN}✓ Cleaned crontab${NC}"

# Clean systemd services
systemctl stop systemhelper 2>/dev/null || true
systemctl disable systemhelper 2>/dev/null || true
rm -f /etc/systemd/system/systemhelper.service
rm -f /etc/systemd/system/system/*/systemhelper.service
systemctl daemon-reload
echo -e "${GREEN}✓ Cleaned systemd services${NC}"

# Step 4: Check for suspicious network connections
echo -e "${YELLOW}[4/8] Checking for suspicious network connections...${NC}"
netstat -tulpn | grep -E "LISTEN|ESTABLISHED" | grep -vE "127.0.0.1|::1|nginx|pm2|node|python|ssh" || echo "No suspicious connections found"
echo -e "${GREEN}✓ Network check complete${NC}"

# Step 5: Update Next.js to latest version (patch CVE-2025-55182)
echo -e "${YELLOW}[5/8] Updating Next.js to patch CVE-2025-55182...${NC}"
cd /var/www/waxvalue || cd ~/waxvalue || { echo -e "${RED}✗ Cannot find waxvalue directory${NC}"; exit 1; }
npm install next@latest react@latest react-dom@latest --save
echo -e "${GREEN}✓ Next.js updated${NC}"

# Step 6: Secure API routes - Add rate limiting headers
echo -e "${YELLOW}[6/8] Securing API routes...${NC}"
# This will be done in the codebase
echo -e "${GREEN}✓ API routes will be secured in code${NC}"

# Step 7: Update firewall rules
echo -e "${YELLOW}[7/8] Updating firewall rules...${NC}"
# Allow only necessary ports
if command -v ufw &> /dev/null; then
    ufw default deny incoming
    ufw default allow outgoing
    ufw allow 22/tcp
    ufw allow 80/tcp
    ufw allow 443/tcp
    ufw --force enable
    echo -e "${GREEN}✓ Firewall configured${NC}"
else
    echo -e "${YELLOW}⚠ UFW not installed, skipping firewall setup${NC}"
fi

# Step 8: Restart services
echo -e "${YELLOW}[8/8] Restarting services...${NC}"
pm2 delete all 2>/dev/null || true
cd /var/www/waxvalue || cd ~/waxvalue

# Restart backend
cd backend
source venv/bin/activate
pm2 start "uvicorn main:app --host 127.0.0.1 --port 8000" --name waxvalue-backend --max-memory-restart 500M
deactivate
cd ..

# Restart frontend
pm2 start "npm run dev" --name waxvalue-frontend --max-memory-restart 500M
pm2 save
pm2 startup

echo -e "${GREEN}✓ Services restarted${NC}"

echo ""
echo "=========================================="
echo -e "${GREEN}  CLEANUP COMPLETE!${NC}"
echo "=========================================="
echo ""
echo "Next steps:"
echo "1. Review PM2 logs: pm2 logs"
echo "2. Check for any remaining suspicious processes: ps aux | grep -E 'systemhelper|minerd|xmrig'"
echo "3. Monitor system resources: htop"
echo "4. Review Nginx access logs: tail -f /var/log/nginx/access.log"
echo "5. Change all passwords (SSH, database, etc.)"
echo "6. Review and update your Next.js API routes to add authentication"
echo ""
echo "IMPORTANT: Update your Next.js API routes to require authentication!"
echo "All API routes should verify user authentication before processing requests."

